:revnumber: {project-version}
:example-caption!: toto
ifndef::imagesdir[:imagesdir: ../../main/resources/images]
ifndef::sourcedir[:sourcedir: ../../main/java]

= Java and docker, what's up ?

2017-06-13

image::akira-java-docker.jpg[scaledwidth=55%]


== Disclaimer

[medium]
Le code et les situations de ce récit étant purement fictifs, toute ressemblance avec des personnes ou des situations existantes ou ayant existé ne saurait être que fortuite ;-)
 
[NOTE.speaker]
--
To do
--

== Who we are

[width="95%",frame="topbot",options="header"]
|======================
|Jean-Christophe Sirot |Charles Sabourdin
a|image::JcSirot-02.png[scaledwidth=65%]         a|image::CaSabourdin-02.png[scaledwidth=65%]
|Tech lead chez Weborama        a|Architect chez IPPON technologies
|       | 
|======================

== My microservice

=== Simple server

[source,java,medium]
.Java code from project
----
include::{sourcedir}/KaboomServer.java[tags=start-server,indent=0]
----

=== Look closer to treatment

[source,java,medium]
.Java code from project
----
include::{sourcedir}/KaboomServer.java[tags=memory-monger,indent=0]
----

=== Test on my machine

[source,java,medium]
.local test ;-)
  cd $PROJECT/target/classes && \
java KaboomServer 9090 

[source,bash,medium]
curl http://127.0.0.1:9090/kaboom

=== Test on my docker machine

[source,java,medium]
.on docker
  # docker-machine create --driver virtualbox demo-jvm ; \
eval $(docker-machine env demo-jvm) && \
cd $PROJECT/ && \
docker build -t dockerfile.jdk8.alpine.34.111 -f
./src/main/dockerfiles/Dockerfile.jdk8.alpine.34.111 ./ &&
docker run -it -p 9090:9090 \
-e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111

[source,bash,medium]
curl http://$(docker-machine ip demo-jvm):9090/kaboom



== Let's move to prod...

image::coyote-plan.jpg[scaledwidth=70%]

=== Shared ressources

start n docker with 256M (this is production, ressources are shared ;-)
  
[source,bash,medium]
 ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 1 --java-param 0
   
[source,java,medium]
docker run -it -m 256M -p 9090:9090 -e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111
   
[source,java,medium]
java  KaboomServer 9090
  

[NOTE.speaker]
--
CAS : ressources problem
Please production increase ram to the docker it has been "OOMKilled"
--

=== increase the RAM ;-)


[source,java,medium]
  ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 2 --java-param 0
   
[source,java,medium]
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111
    
[source,java,medium]
java  KaboomServer 9090

[NOTE.speaker]
--
CAS : It still crash that't you code dude, please set Xmx correctly...   
--

=== set -Xms256M -Xmx512M


[source,java,medium]
  ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 2 --java-param 1
  
[source,java,medium]
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111
    
[source,java,medium]
java  -Xms256M -Xmx512M  KaboomServer 9090
  
  
[NOTE.speaker]
--
CAS : It still does not crash but gosh it swap so much, and if crahs sometime   
--

=== Something that never happen ;-)


[source,java,medium]
  ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 2 --java-param 2

[source,java,medium]
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111
    
[source,java,medium]
java -Xms512M -Xmx1024M  KaboomServer 9090

[NOTE.speaker]
--
CAS : In fact, this will fill the swap, but in order to show it, we will increase the -Xmx
--


=== It swap too much ? Let's remove it


[source,java,medium]
 ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 3 --java-param 3
  
[source,java,medium]
docker run -it -m 512M --memory-swap -1 -p 9090:9090 -e "JAVA_PARAM=3" dockerfile.jdk8.alpine.34.111
   
[source,java,medium]
java -Xms1024M -Xmx3584M  KaboomServer 9090

[NOTE.speaker]
--
CAS : In fact, this will still fill the swap, but in order to show it, we will increase the -Xmx
--

=== The hard way

[source,bash,medium]
sudo swapoff -a

[source,java,medium]
 ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 3 --java-param 3

[source,java,medium]
docker run -it -m 512M --memory-swap -1 -p 9090:9090 -e "JAVA_PARAM=3" dockerfile.jdk8.alpine.34.111
   
[source,java,medium]
java -Xms1024M -Xmx3584M  KaboomServer 9090

[NOTE.speaker]
--
CAS : OMKill ;-)
--


== What the ....

=== Something to remember 

 * Docker is not a VM
 * It's link to the kernel

 
[NOTE.speaker]
--
CAS : think /proc..., think maloc 
--

=== Remember where it came from 

 * Lxc 
 * chroot
 * (bsd) jail

 
[NOTE.speaker]
--
CAS : think /proc..., think maloc 
--

=== What can we do

 * tune the Xmx
 * use jdk9
 * use jdk8 > 131


[NOTE.speaker]
--
CAS : ressources problem
Please production increase ram to the docker it has been "OOMKilled"
--

== ExperimentalVMOptions

image::emclume.jpg[scaledwidth=70%]

=== ExperimentalVMOptions

 * -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap
 * -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=1
 

[NOTE.speaker]
--
CAS : It's experimental, use canary dev ;-)
--

=== -XX:+UseCGroupMemoryLimitForHeap

 
[source,java,medium]
 ./src/main/demoscript/coyote.js --action run --image 2 --docker-param 3 --java-param 3
[source,java,medium] 
docker run -it -m 512M --memory-swap -1 -p 9090:9090 \
 -e "JAVA_PARAM=7" dockerfile.jdk8.alpine.36.131

[source,java,medium]   
java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap \
-XshowSettings:vm KaboomServer 9090
    

=== -XX:MaxRAMFraction=1

[source,java,medium]
  ./src/main/demoscript/coyote.js --action run --image 2 --docker-param 3 --java-param 3
  
[source,java,medium]
docker run -it -m 512M --memory-swap -1 -p 9090:9090 \
 -e "JAVA_PARAM=9" dockerfile.jdk8.alpine.36.131

[source,java,medium]  
java -XX:+UnlockExperimentalVMOptions \
 -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=1 \
 -XshowSettings:vm KaboomServer 9090

=== -XX:MaxRAMFraction=2

[source,java,medium]
  ./src/main/demoscript/coyote.js --action run --image 2 --docker-param 3 --java-param 3
  
[source,java,medium]
docker run -it -m 512M --memory-swap -1 -p 9090:9090 \
 -e "JAVA_PARAM=11" dockerfile.jdk8.alpine.36.131

[source,java,medium]
java -XX:+UnlockExperimentalVMOptions \
 -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=2 \
 -XshowSettings:vm KaboomServer 9090

[NOTE.speaker]
--
CAS : It's experimental, use canary dev ;-)
--

== Take away

image::willy-il-coyote-arrow.jpg[scaledwidth=70%]

[NOTE.speaker]
--
CAS : 
 - VM java et JM docker have philo similarity
 - Docker is not VM
 - Let docker deal with ressource management
--

== Questions

image::Thats_all_folks.png[scaledwidth=150%]
