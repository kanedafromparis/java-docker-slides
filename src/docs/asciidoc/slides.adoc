:revnumber: {project-version}
:example-caption!: toto
ifndef::imagesdir[:imagesdir: ../../main/resources/images]
ifndef::sourcedir[:sourcedir: ../../main/java]

= Java and docker, what's up ?

2017-06-13

image::akira-java-docker.jpg[scaledwidth=55%]


== Disclaimer

[medium]
Le code et les situations de ce récit étant purement fictifs, toute ressemblance avec des personnes ou des situations existantes ou ayant existées ne saurait être que fortuite ;-)
 
[NOTE.speaker]
--
To do
--

== Who we are

[width="95%",frame="topbot",options="header"]
|======================
|Jean-Christophe Sirot |Charles Sabourdin
a|image::JcSirot-02.png[scaledwidth=65%]         a|image::CaSabourdin-02.png[scaledwidth=65%]
|Tech lead chez Weborama        a|Architecte chez IPPON technologies
|       | 
|======================

== My microservice

image::projetCoyote.png[]

=== Simple server

[source,java,medium]
.Java code from project
----
include::{sourcedir}/KaboomServer.java[tags=start-server,indent=0]
----

=== Look closer to treatment

[source,java,medium]
.Java code from project
----
include::{sourcedir}/KaboomServer.java[tags=memory-monger,indent=0]
----

=== Test on my machine

[source,java,medium]
.local test ;-)
java -cp target/classes KaboomServer 9090

[source,bash,medium]
curl http://127.0.0.1:9090/kaboom

=== Test on my docker machine

[source,java,medium]
.on docker
//  # docker-machine create --driver virtualbox demo-jvm ; \
// eval $(docker-machine env demo-jvm) && \
// cd $PROJECT/ && \
// docker build -t dockerfile.jdk8.alpine.34.111 -f
// ./src/main/dockerfiles/Dockerfile.jdk8.alpine.34.111 ./ &&
docker run -it -p 9090:9090 \
-e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111

[source,bash,medium]
curl http://$(docker-machine ip demo-jvm):9090/kaboom

=== Everything OK!

Lets push the docker image

image::acmeBox.jpg[scaledwidth=70%]

== Let's move to prod...

image::coyote-plan.jpg[scaledwidth=70%]

=== Shared ressources

start n docker with 256M (this is production, ressources are shared ;-)
  
// [source,bash,medium]
// ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 1 --java-param 0
   
[source,java,medium]
docker run -it -m 256M -p 9090:9090 -e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111
   
[source,java,medium]
java  KaboomServer 9090
  

[NOTE.speaker]
--
CAS : ressources problem
Please production increase ram to the docker it has been "OOMKilled"
--

=== increase the RAM ;-)


// [source,java,medium]
//  ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 2 --java-param 0
   
[source,java,medium]
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=0" dockerfile.jdk8.alpine.34.111
    
[source,java,medium]
java  KaboomServer 9090

[NOTE.speaker]
--
CAS : It still crash that't you code dude, please set Xmx correctly...   
--

=== set -Xms256M -Xmx512M


// [source,java,medium]
//  ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 2 --java-param 2
  
[source,java,medium]
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=2" dockerfile.jdk8.alpine.34.111
    
[source,java,medium]
java  -Xms256M -Xmx512M  KaboomServer 9090
  
  
[NOTE.speaker]
--
CAS : It still does not crash but gosh it swap so much, and if crahs sometime   
--

=== Something that never happen ;-)


// [source,java,medium]
//  ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 2 --java-param 2

[source,java,medium]
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=3" dockerfile.jdk8.alpine.34.111
    
[source,java,medium]
java -Xms512M -Xmx1024M  KaboomServer 9090

[NOTE.speaker]
--
CAS : In fact, this will fill the swap, but in order to show it, we will increase the -Xmx
--


=== It swap too much ? Let's remove it


// [source,java,medium]
// ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 3 --java-param 3
  
[source,java,medium]
docker run -it -m 512M --memory-swap -1 -p 9090:9090 -e "JAVA_PARAM=3" dockerfile.jdk8.alpine.34.111
   
[source,java,medium]
java -Xms1024M -Xmx3584M  KaboomServer 9090

[NOTE.speaker]
--
CAS : In fact, this will still fill the swap, but in order to show it, we will increase the -Xmx
--

=== Hey, dude, read the doc ;-)

// [source,bash,medium]
// sudo swapon -a

//[source,java,medium]
// ./src/main/demoscript/coyote.js --action run --image 0 --docker-param 3 --java-param 3
  
[source,java,medium]
docker run -it -m 512M --memory-swap 515M -p 9090:9090 -e "JAVA_PARAM=3" dockerfile.jdk8.alpine.34.111
   
[source,java,medium]
java -Xms1024M -Xmx3584M  KaboomServer 9090

[NOTE.speaker]
--
CAS : In fact, this will still fill the swap, but in order to show it, we will increase the -Xmx
--



== What the ....

image::helpCoyote.jpg[]

=== Something to remember 

 * Docker is not a VM
 * It's link to the kernel

 
[NOTE.speaker]
--
CAS : think /proc..., think maloc 
--

=== Remember where it came from 

 * Lxc 
 * chroot
 * (bsd) jail

 
[NOTE.speaker]
--
CAS : think /proc..., think maloc 
--

=== JVM in a Dockerland 

@todo draw the vm memory guest

=== JVM in a Dockerland 

@todo draw the vm memory guest



=== What can we do

== Tune your Xmx

//image::http://blog.christianposta.com/images/fabric8_logo.svg[]



[NOTE.speaker]
--
CAS : ressources problem
https://github.com/fabric8io-images/java/blob/master/images/jboss/openjdk8/jdk/container-limits

--

== use jdk9

https://github.com/fabric8io-images/java/blob/master/images/jboss/openjdk8/jdk/container-limits


== ExperimentalVMOptions

image::emclume.jpg[scaledwidth=70%]

=== -XX:+UseCGroupMemoryLimitForHeap

//[source,java,medium]
// ./src/main/demoscript/coyote.js --action run --image 1 --docker-param 2 --java-param 20

[source,java,medium] 
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=20" \
 dockerfile.jdk8.alpine.36.131

[source,java,medium]   
cmd : java  -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XshowSettings:vm  KaboomServer 9090

=== Bewarw Xmx do override

//[source,java,medium]
// ./src/main/demoscript/coyote.js --action run --image 1 --docker-param 2 --java-param 21

[source,java,medium] 
docker run -it -m 512M -p 9090:9090 -e "JAVA_PARAM=21" \
 dockerfile.jdk8.alpine.36.131

[source,java,medium]   
cmd : java  -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=1 -XshowSettings:vm  KaboomServer 9090
    


=== thinks -XX:MaxRAMFraction=1

//[source,java,medium]
//  ./src/main/demoscript/coyote.js --action run --image 1 --docker-param 2 --java-param 22
  
[source,java,medium]
docker run -it -m 512M  -p 9090:9090 \
 -e "JAVA_PARAM=22" dockerfile.jdk8.alpine.36.131

[source,java,medium]  
java -XX:+UnlockExperimentalVMOptions \
 -XX:+UseCGroupMemoryLimitForHeap -XX:MaxRAMFraction=1 \
 -XshowSettings:vm KaboomServer 9090


== Take away

image::willy-il-coyote-arrow.jpg[scaledwidth=70%]

[NOTE.speaker]
--
CAS : 
 - VM java et JM docker have philo similarity
 - Docker is not VM
 - Let docker deal with ressource management
--

=== memory should have only one master


=== some useful -X options


=== you shoudl alway have 3 elements at least ;-)



== Questions

image::Thats_all_folks.png[scaledwidth=150%]
